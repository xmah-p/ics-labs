#4556277 11月前 2022-12-28 17:1961 67 
#proxylab
求问https连接的具体过程是什么样的，感觉writeup上写的不是很清楚，dz自己上网查也没太弄明白
#20572802 11月前 2022-12-28 17:20
[Alice] 我也
#20572859 11月前 2022-12-28 17:22
[Bob] 其实也不用明白https具体是怎么握手的，只要让proxy接到connect指令后无脑转发就好....
#20572932 11月前 2022-12-28 17:26
[洞主] Re Bob: dz尝试了无脑转发，然后失败了😂应该是转发的内容有问题
#20576420 11月前 2022-12-28 19:58
[Carol] 我试了无脑转发结果失败了…反正就两分不要也罢
#20576560 11月前 2022-12-28 20:03
[Bob] Re 洞主: 收到啥就转发啥就行，不用进行任何处理..
#20576662 11月前 2022-12-28 20:06
[Dave] Re Bob: 测试https的是real-2048吗？
#20576683 11月前 2022-12-28 20:06
[Bob] Re Dave: 应该是的
#20579925 11月前 2022-12-28 22:00
[Eve] 你要做的事情是这样的
#20579958 11月前 2022-12-28 22:01
[Eve] 首先，读入客户端的connect请求报头，与服务器建立连接，给客户端发回
#20579966 11月前 2022-12-28 22:01
[Eve] HTTP/1.1 200 Connection Established\r\nConnection: close\r\n\r\n
#20580030 11月前 2022-12-28 22:03
[Eve] 然后，用两个线程(其中一个可以是主线程)分别进行服务器→客户端和客户端→服务器的转发，注意要使用Unix read函数而不是rio的包装函数
#20580084 11月前 2022-12-28 22:05
[Eve] 这部分是今年贵校新加的……writeup确实写的很烂，和CMU写的writeup形成了鲜明对比
#20580450 11月前 2022-12-28 22:17
[Dave] Re Eve: ！那想请问一下E大佬，proxy给服务器发请求的时候request line是“GET / HTTP/1.0”还是什么呢？我这边一直提示说“400 The plain HTTP request was sent to HTTPS port”
#20581608 11月前 2022-12-28 23:00
[Dave] Re Eve: ！！！！！！感谢Eve大善人😭 不需要request line/request header，，过了！！！！！祝Eve绩点高高平安喜乐😭😭
#20584489 11月前 2022-12-29 00:28
[Eve] Re Dave: 哈哈没事没事
#20589753 11月前 2022-12-29 10:08
[洞主] 谢谢eve和各位积极讨论的洞友，dz也做出来啦
#20598644 11月前 2022-12-29 17:17
[Francis] Re Eve: 感谢Eve,以及能不能问一问为什么用Rio包装函数就会timeout,但是用read就不会呢? 我这几天一直卡在这个地方, 看了树洞才发现
#20604052 11月前 2022-12-29 21:07
[Grace] Re Eve: Eve大佬能说一下CONNECT报头后面还有啥要加的嘛，我看writeup后面还有一行HOST，然后下面又是省略号，不知道报头是不是要像HTTP一样全部写上
#20607743 11月前 2022-12-29 23:14
[Eve] Re Francis: 如果你看了书上代码就会发现，为了所谓的鲁棒性，rio的函数在遇到不足值时会反复调用read。例如你以MAXLINE为参数调用rio的函数，而客户端只输入了不到MAXLINE个字节，这时就会无限阻塞在rio函数调用的read里
#20607777 11月前 2022-12-29 23:15
[Eve] Re Francis: 注意这时客户端还在等待服务器的回复，没有断开连接，所以read也不会检测到EOF
#20607958 11月前 2022-12-29 23:20
[Eve] Re Grace: 把CONNECT报头全部读入(结束标志是一个空行)，然后扔掉就可以了，不用转发给任何人
#20615028 11月前 2022-12-30 11:01
[Grace] Re Eve: 哦哦哦好的，谢谢E君，我这就去试试
#20647179 11月前 2022-12-31 20:37
[Grace] Re Eve: 我也做出来啦，谢谢E君~祝E君和洞里其他朋友新年快乐~
#20647192 11月前 2022-12-31 20:38
[Grace] 顺便我调这个第四部分调了好几天，也可以回答一下后来看到这里的朋友的问题了23333
#20655394 11月前 01-01 11:42
[Alice] Re Grace: 谢谢Grace。请问real page这一部分总是那两个cache的测试过不了，就是cahce-lru/concurrent，可能是什么原因呢？
#20656689 11月前 01-01 13:31
[Grace] Re Alice: 我感觉可能是互斥锁的问题？我之前CACHE出问题的时候是因为有一个地方的IF语句里面我RETURN了但是忘记把锁释放了，A君可以检查一下有没有一些地方加锁/释放锁漏写了或者写错了
#20657761 11月前 01-01 14:42
[Alice] Re Grace: 满分了，谢谢G。是因为服务器响应可能是二进制文件，所以一些IO函数要改，我忘了。
#20658567 11月前 01-01 15:30
[Grace] Re Alice: 嗷那就是MEMCPY的问题哈哈哈
#20663465 11月前 01-01 18:43
[Hans] 请问怎么实现在TCP一端关闭的时候另一个线程也退出呀
#20665180 11月前 01-01 20:01
[Grace] Re Hans: 不需要吧，客户端和服务器的线程是分离的，两边不一定要同步退出吧
#20674272 11月前 01-02 08:30
[Isabella] Re Eve: 我也过了，谢谢E君！
#20675890 11月前 01-02 11:15
[Hans] Re Grace: 谢谢 还想问下proxy用rio给客户端发回200之后就可以直接开始read了吗，中间还有什么操作呢，我read一直没有反应
#20676132 11月前 01-02 11:28
[Grace] Re Hans: 对，发回Established信号之后就可以创建线程了，主线程+对等线程分别完成服务器到客户端/客户端到服务器的信息传输
#20680093 11月前 01-02 15:16
[Jason] Re Grace: 请问这两步信息传输需要打开新的套接字描述符吗，还是用原来的两个就行？
#20680904 11月前 01-02 16:12
[Grace] Re Jason: 不需要的，就用原来的就行
#20682542 11月前 01-02 17:41
[Jason] Re Grace: 好的，谢谢G君
#20688176 11月前 01-02 22:06
[Kate] 请问为什么要开两个线程，不能一个线程把两件事都干了吗
#20688189 11月前 01-02 22:06
[Kate] 以及，怎么判断对面的 socket 关掉了啊，，，好像线程也不能一直挂着吧（不太会）
#20688581 11月前 01-02 22:19
[Grace] Re Kate: 我理解的是real-2048是实时交互的，你一个线程内只能是线性的要么先等服务器弄完要么先等客户端弄完，这个显然没法玩2048.然后线程你detach分离出来就行了反正自动回收，不用管对面关没关
#20694338 11月前 01-03 02:06
[Louis] 请问最后realpage里cache-concurrency/lru两个点怎么过呀？听说要把数据缓存的strcpy改成memcpy，还有读数据的那个地方用readnb，dz改了之后还是过不去qaq，是除了这两个地方还有要改的吗？rio包的读写对于二进制文件还可以用嘛？
#20696337 11月前 01-03 09:39
[Grace] Re Louis: 这个我感觉是CACHE写的有问题？也有可能是互斥锁有地方漏了。rio对二进制文件可以用的，反正我除了HTTPS用了READ其他地方都是RIO，也没用READNB
#20697118 11月前 01-03 10:33
[Margaret] Re Grace: 想问问G君是不是不处理CONNECT报头那realpage就必然都会爆0呢？
#20697210 11月前 01-03 10:38
[Hans] Re Grace: 我又回来了555 可以麻烦说一下2048那一组有几个connect，以及client和server传了大概多少byte数据吗，我这里read的话第一次client返回-1挂了，第二次server返回-1挂了，然后就报timeout
#20697364 11月前 01-03 10:47
[Grace] Re Margaret: 不会呀，CONNECT就一个点，其他像TINY一样先判断下是不是GET就行
#20697404 11月前 01-03 10:49
[Grace] Re Hans: 嘶，好像和数据大小关系不大诶，我调试的时候都没关心过大小，不过READ我就是一个字符一个字符读的，读完就完了（（
#20697475 11月前 01-03 10:52
[Hans] Re Grace: 那read读完是-1退出还是0退出呢（
#20697779 11月前 01-03 11:12
[Grace] Re Hans: 0吧，遇到-1的话肯定是读中途出问题了
#20698401 11月前 01-03 11:45
[Margaret] Re Grace: qwq想问一下G君我第一个sancheck就过不了是为什么啊（它说我useragent hdr错了（（但是明明我是复制黏贴...而且如果真的useragent都错了的话之前的样例是怎么过的嘛（）
#20698883 11月前 01-03 12:14
[Jason] 我在2048里面用read的时候总会报错read：bad file descriptor，不知道为什么😭
#20699757 11月前 01-03 13:08
[Grace] Re Margaret: 嘶，这个问题我还真没遇到...好奇怪
#20699775 11月前 01-03 13:10
[Grace] Re Jason: 我查了一下貌似是有的地方没CLOSE？然后到达上限之后就打不开新的了
#20699792 11月前 01-03 13:11
[Margaret] Re Grace: 嘶...我甚至怀疑是没有给浏览器setting里面代理设置好（（但是显然不应该是这样啊
#20700009 11月前 01-03 13:22
[Grace] Re Margaret: 浏览器那个只影响自己调试嘛，肯定不影响跑分的
#20700240 11月前 01-03 13:35
[Margaret] Re Grace: qaq请问一下Grace除了cache还有哪里需要加锁吗...因为我好像realpage调试的时候www只有一开始的一些proxy处理了报头到了后面就不处理了（似乎
#20700574 11月前 01-03 13:52
[Jason] Re Grace: 谢谢，确实是这样的。那么G君是在哪里close的呢？我总觉得两个线程传数据，如果一个传完了close掉，另一个线程还没传完，那不就出问题了吗？
#20701267 11月前 01-03 14:30
[Grace] Re Margaret: 其他地方应该是没有锁的，就CACHE需要，不过很容易漏写
#20701300 11月前 01-03 14:32
[Grace] Re Jason: 我都是传完了在return的时候CLOSE的，但线程DETACH之后是自动回收的吧感觉好像没啥问题
#20701411 11月前 01-03 14:41
[Margaret] Re Grace: doge !是因为在realpage里面用了cache然后溢出了ww
#20701898 11月前 01-03 15:16
[Grace] Re Margaret: 啊这哈哈哈哈哈
#20720309 11月前 01-04 10:03
[Nathan] 请问一下，real-page 2048为什么我的代理能从客户端读内容，但在server段读会卡住呢（用的是read）
#20721640 11月前 01-04 11:08
[Grace] Re Nathan: 是分了线程的读入的吗？如果同一个线程处理双方通信肯定会卡住的
#20722514 11月前 01-04 11:44
[Nathan] Re Grace: 是的
#20726387 11月前 01-04 14:40
[Grace] Re Nathan: 嘶，那我也不太清楚，也许CONNECT报头之类的少了\r\n?
#20749834 11月前 01-05 13:59
[Kate] 淦，终于跑通了
#20749848 11月前 01-05 14:00
[Kate] 查了 https 的机制才知道，request header 是给 proxy 看的，不需要发给服务器
#20749861 11月前 01-05 14:01
[Kate] proxy 只需要把 header 读完丢掉，发个 success 回去，然后闭着眼睛转发就行了
#20784017 11月前 01-06 21:25
[Grace] 马上要截至了，完结撒花！（大逃


请问proxylab debug的时候输入命令curl -v --proxy http://localhost:3020 http://localhost:3019/cgi-bin/adder?1020&29 
发现每次tiny上显示命令是GET /cgi-bin/adder?1020 HTTP/1.0
自动把&29给略过了
这是为什么呀。。。救救孩子吧TAT

# ics xk 信科
#20768031 11月前 01-06 02:02
[Alice] 可以在URL部分前后加引号。这应该是shell解析到&符号，把这条命令当成需要在后台执行的任务，所以&之后的内容没被算在URL里