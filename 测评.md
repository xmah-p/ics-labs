# archlab

对应第四章“处理器体系结构”，采用的编程语言是第四章学的Y86汇编。这个lab按照优化程度给分，代码量和难度中等，想得高分容易，但想优化到满分有点难
第一部分：手写Y86汇编程序     第二部分：往Y86指令集里加入新指令   
第三部分：优化处理器流水线，使得这个流水线跑程序的CPE尽可能地小，不做任何优化的CPE是15.1，优化到10.5开始有分数，优化到7.5满分

一些排坑：1.dz在做part2的时候，本地测试没完全通过，但提交之后就满分了。可供参考。    2.第一部分手写Y86程序，不需要使得程序对任何数据都成立，只需要自己在程序里手动添加特定测试数据即可   3.part3的优化，想拿到满分思路相对单一（循环展开+三叉树+跳转表），【小心查重】【小心查重】【小心查重】



另外补充一下archlab，这里改分支预测可以尝试一下，改bbtfnt能略微提升，进一步改还能提升更多（似乎能有办法全部预测正确？）。
我大改了hcl，代码只简单做了一下展开和冒险消除，甚至没做三叉跳转表，CPE能到7以下。


archlab的那个操作其实很简单。在第三个lab判定数组里面数字与0的关系时，在实现成二叉树的结构之后，只需要利用异或操作，两个两个地对数组里面的数字进行计数，就可以在这两个数字符号相反的时候节省一次额外判定的时间，从而很轻松地拿到满分。如果学过数字逻辑的同学应该能意识到这个就是半加器的原理。

dz用的是7路展开+余数用bst，感觉再优化也就挤气泡调逻辑了

其实循环展开再多展开一两层就可以满分了,余数处理上可以用bst多搜一层,原本是考虑到2层bst正好7个节点于是用了7路,但多展开一下还是可以榨一丢丢分出来,实测9路+bst可以满分
dz魔改了一波hcl,然后就一发不可收拾了
看来人总是会真香的(点头)

[Dave] 可以switch
#18892027 12月前 2022-10-22 02:55
[Dave] pushq＋ret
#18894070 12月前 2022-10-22 11:06
[Carol] Re Dave: 如果已经算出了跳转地址，为什么不直接jmp？
#18894640 12月前 2022-10-22 11:49
[Carol] Re Dave: 懂了，因为jmp的操作数必须是立即数

[Bob] 看yis对各个指令的实现
#18884263 1年前 2022-10-21 20:15
[洞主] Re Bob: 在哪里看呢？dz运行sdrivers和ldrivers似乎都没发现问题
#18884325 1年前 2022-10-21 20:17
[Bob] yis的具体实现在misc这个文件夹里，阅读C代码就可以了


ics archlab
实现了条件加法之后发现我自己那套汇编CPE很低，但是跟他给的yis不兼容..这要怎么解决啊
#18866937 1年前 2022-10-20 21:36
[Alice] 同问，蹲
#18867091 1年前 2022-10-20 21:45
[Bob] 想办法判断运行时环境，并执行兼容于当前环境下的代码
#18867313 1年前 2022-10-20 21:57
[洞主] Re Bob: woc这怎么判断啊
#18870044 1年前 2022-10-20 23:53
[洞主] 懂了 还愿 谢谢bob
#18877930 1年前 2022-10-21 14:01
[Carol] Re 洞主: dz能细说一下怎么解决的吗？
#18881266 1年前 2022-10-21 17:32
[Dave] 实现了条件加法之后，iaddq的行为就会被改变，从而通过检查iaddq有何行为，即可确定运行时环境
#18883095 1年前 2022-10-21 19:18
[洞主] Re Dave: hh我的写法更暴力一点
#18924531 12月前 2022-10-23 23:28
[Eve] Re Dave: 很好奇。这样的话，后面想用正常iaddq时，不是会浪费很多语句吗
#18929298 12月前 2022-10-24 10:53
[Francis] Re Eve: 如果监测到iaddq是正常的话，那就意味着在进行的是yis测试，那我们就不需要管时间了，也就是说……执行最开始的original lines不就行了～


[Alice] 做7/8位循环展开，统一mr统一rm避免数据冒险，处理尾巴时mr了再jmp。实测有效。
#3350802 3年前 2019-11-06 16:03
[Bob] Re Alice: 求问A君，展开到七路及以上就超长了该怎么解决呀😭😭
#3350960 3年前 2019-11-06 16:22
[Alice] Re Bob: 处理剩下几个元素时可以统一写七个拷贝，然后根据剩下的个数跳到中间去。用c语言解释就是 switch(s): case 7: case 6: case 5: 之类的。每个分支拷贝对应位置的元素，因为没有break就会掉下去继续拷贝前面的元素。
#3350971 3年前 2019-11-06 16:24
[Alice] Re Bob: 例如剩余4个就会跳到case 4拷贝第四个元素，然后掉下去到case 3, 2, 1依次拷贝第3/2/1个元素。这样不同情况可以共用代码，应该就不会超长了吧


# cachelab

终于脱离了汇编语言，从cache开始的lab就都是正经的C语言编程了。这个lab码量比前几个要大一些，也是按优化给分，优化的过程有点难

lab分两部分，第一部分：手动模拟一个高速缓存，第二部分：用缓存优化矩阵相乘的程序，降低缓存miss次数。part2的优化挺烧脑的，最后一题cmu要求优化到2000给满分，贵校的lab加强了要求，优化到1600才能满（我们PKU真是太厉害辣）

排坑：注意part1是64位地址而不是32位！！！坑了不少人的bug
part2的解决方式基本唯一：用矩阵分块，实在不会可以去google上找文章借鉴一下思路，但别抄代码就行




# shelllab

对应第8章异常控制流，异常和信号处理的内容，以及第十章的重定位（第10章重定位这块一定要好好看，上课存在感比较低，但期末有可能和第8章一块出大题）。码量比较大，debug难度显著大于前几个lab，菜鸡dz debug花了20小时左右，供参考
具体内容是写一个简易的linux shell，内容方面三言两语也说不清楚，就不说了

排坑：1.这个lab有助教的手动评分，一定要注意各种编程细节（重要）！！！可以找本班助教或者其他班同学要一份评分标准    2.强烈建议先好好看一遍第八章第十章，读懂书上代码（书上也确实有不少代码可以抄），确保理解了所有书上代码再开始写
3.最后一组测试数据的kill -1有点坑；另外有一组测试数据，要屏蔽SIGHUP信号（这玩意上课不讲，实在有点坑），学弟学妹们做的时候小心一下


# malloclab

具体内容为写一个动态内存分配器。debug和优化过程极度痛苦，今年降低了难度，但只是降低了优化程序的难度。想debug从而跑通程序仍然很难。dz水平垃圾，跑通程序+优化到接近满分的过程足足花了30小时
【建议早点开始，做好心理准备，给malloc留出足够多的时间】【建议速战速决，malloclab在期末季前两周放出来，非常魔鬼。如果为了3分5分的小优化花上一天时间，实在不太值】

大众思路为分离空闲链表，少数大佬可能会写平衡树，但普通人采用前者，亲测也能95+

排坑：1.malloclab也有助教手动评分环节，强烈建议打磨好自己程序的每一个细节   2.地址是8字节不是4字节！其实可以用4字节偏移量表示地址（指针），但需要做特殊处理。千万不要直接用4字节表示地址     3.书上的优化方式很有用（比如去脚部），建议写lab之前好好把书看一遍，虽然照搬书上的方法会给0分，但看懂了就很好写
关于debug方式：1.gdb  2.自己写的checkheap函数  3.printf打法打印相关信息

